import React, { useEffect, useMemo, useRef, useState } from "react";
import SignatureCanvas from "react-signature-canvas";
import { PDFDocument } from "pdf-lib";
import { CheckCircle2, Copy, FileDown, FilePenLine, Users } from "lucide-react";

// ====== נתוני דיירים (לפי הסדר בעמודה A בגוגל שיט) ======
const RESIDENTS = [
  "יצחק יוסף מלריך",
  "אפרים דנקו",
  "הלפרין זהבה גבריאל",
  "רימון שרה שרי(רומן)",
  "שולמית נחמוד",
  "אייבי מוסקוביץ",
  "קורדון מרי",
  "אביי פקדו",
  "יהושוע לפיד",
  "טקלה יוורקה",
  "רווית שושן",
  "ישראל רוזנבוים",
  "צח עשת",
  "אהרון בוקובזה",
  "שלום",
  "ימית גולן",
  "נועם עמרם",
  "הפטקה אופיר",
  "גליק אפרים",
  "גרוס ליפא- אדיר",
  "ילנה זרצקי",
  "וישניאנסקי אנה",
  "סרגיי מסיוטין",
  "אולגה פבלוב",
  "נטליה",
  "אלמקאן- גטהון וצ'וקולוק אבייה",
  "ללא עברית",
  "עומרי ג'נבה",
  "ליכטנשטיין יהודה אריה לייב",
  "ריטה אובטרכט",
  "יוסי אוחיון (שני)",
  "יפית-בהטה אסממאו",
];

const STORAGE_PREFIX = "apt-signature-unit-";

// עוזר: קריאת unitId מה-URL (?unitId=1)
function getUnitIdFromUrl() {
  if (typeof window === "undefined") return null;
  const params = new URLSearchParams(window.location.search);
  const raw =
    params.get("unitId") ||
    params.get("id") ||
    params.get("unit") ||
    params.get("u");
  if (!raw) return null;
  const n = Number(raw);
  if (!Number.isInteger(n) || n < 1 || n > RESIDENTS.length) return null;
  return n;
}

// עוזר: קריאת כל החתימות מה-localStorage
function loadAllSignatures() {
  if (typeof window === "undefined") return {};
  const map = {};
  for (let i = 1; i <= RESIDENTS.length; i++) {
    const raw = window.localStorage.getItem(`${STORAGE_PREFIX}${i}`);
    if (raw) {
      try {
        map[i] = JSON.parse(raw);
      } catch {
        // מתעלם
      }
    }
  }
  return map;
}

// תאריך בפורמט ישראלי קריא
function getTodayDateLabel() {
  try {
    return new Date().toLocaleDateString("he-IL", {
      day: "2-digit",
      month: "2-digit",
      year: "numeric",
    });
  } catch {
    return "";
  }
}

export default function App() {
  const [unitId, setUnitId] = useState(() => getUnitIdFromUrl());
  const [allSignatures, setAllSignatures] = useState(() => loadAllSignatures());
  const [pdfFile, setPdfFile] = useState(null);
  const [statusMsg, setStatusMsg] = useState("");
  const [isBusy, setIsBusy] = useState(false);

  const sigPadRef = useRef(null);

  const todayLabel = useMemo(() => getTodayDateLabel(), []);

  // לעדכן unitId אם המשתמש משנה כתובת (back/forward)
  useEffect(() => {
    function handlePop() {
      setUnitId(getUnitIdFromUrl());
    }
    window.addEventListener("popstate", handlePop);
    return () => window.removeEventListener("popstate", handlePop);
  }, []);

  const isAdmin = unitId == null;
  const residentName =
    !isAdmin && unitId
      ? RESIDENTS[unitId - 1] || `דייר ${unitId}`
      : null;

  const baseUrl =
    typeof window !== "undefined"
      ? window.location.origin + window.location.pathname
      : "";

  // אירוע: החלפת קובץ PDF (למנהל)
  async function handlePdfChange(e) {
    const file = e.target.files?.[0];
    if (!file) return;
    const arr = await file.arrayBuffer();
    setPdfFile(arr);
    setStatusMsg(`PDF נטען: ${file.name}`);
  }

  // ניקוי חתימה (לדייר)
  function clearSignature() {
    sigPadRef.current?.clear();
  }

  // שמירת חתימה (לדייר)
  async function saveSignatureForUnit() {
    if (!unitId) {
      setStatusMsg("שגיאה: לא נמצא מזהה דייר בכתובת.");
      return;
    }
    if (!sigPadRef.current || sigPadRef.current.isEmpty()) {
      setStatusMsg("אנא חתום/י לפני השמירה.");
      return;
    }

    try {
      const dataUrl = sigPadRef.current
        .getTrimmedCanvas()
        .toDataURL("image/png");

      const record = {
        unitId,
        name: residentName,
        dateLabel: todayLabel,
        signatureDataUrl: dataUrl,
        savedAt: new Date().toISOString(),
      };

      window.localStorage.setItem(
        `${STORAGE_PREFIX}${unitId}`,
        JSON.stringify(record)
      );

      const updated = loadAllSignatures();
      setAllSignatures(updated);
      setStatusMsg("החתימה נשמרה בהצלחה. תודה!");
    } catch (err) {
      console.error(err);
      setStatusMsg("ארעה שגיאה בשמירת החתימה.");
    }
  }

  // העתקת לינק ללוח (למנהל)
  async function copyLinkForUnit(unitIndex) {
    if (typeof window === "undefined") return;
    const link = `${baseUrl}?unitId=${unitIndex}`;
    try {
      await navigator.clipboard.writeText(link);
      setStatusMsg(`הלינק לדייר ${unitIndex} הועתק.`);
    } catch {
      setStatusMsg("לא הצלחתי להעתיק אוטומטית – אפשר לסמן ולהעתיק ידנית.");
      console.log(link);
    }
  }

  // הפקת PDF עם כל החתימות (למנהל)
  async function exportMergedPdf() {
    if (!pdfFile) {
      setStatusMsg("אנא העלה PDF לפני הפקת מסמך מאוחד.");
      return;
    }
    setIsBusy(true);
    setStatusMsg("מעבד PDF…");

    try {
      const pdfDoc = await PDFDocument.load(pdfFile);
      const pageCount = pdfDoc.getPageCount();

      for (let i = 1; i <= RESIDENTS.length; i++) {
        const rec = allSignatures[i];
        if (!rec) continue;

        // המרת dataURL ל-byte array
        const res = await fetch(rec.signatureDataUrl);
        const blob = await res.blob();
        const sigBytes = new Uint8Array(await blob.arrayBuffer());

        const pngImage = await pdfDoc.embedPng(sigBytes);

        // חישוב פוזיציה לפי אינדקס דייר
        // נניח 13 שורות לדף, להתאים לפי הצורך:
        const idxZero = i - 1;
        const pageIdx = Math.min(
          Math.floor(idxZero / 13),
          pageCount - 1
        );
        const rowInPage = idxZero % 13;

        const page = pdfDoc.getPage(pageIdx);
        const { width, height } = page.getSize();

        const rowHeight = 32; // אפשר לכוונן
        const startY = height - 260; // נקודת התחלה מעל הטבלה – לכוונן
        const y = startY - rowInPage * rowHeight;

        // חתימה בעמודת "חתימה" – בערך ב־70% מרוחב הדף
        const x = width * 0.68;

        const sigScale = 0.4;
        const dims = pngImage.scale(sigScale);

        page.drawImage(pngImage, {
          x,
          y,
          width: dims.width,
          height: dims.height,
        });
      }

      const bytes = await pdfDoc.save();
      const blob = new Blob([bytes], { type: "application/pdf" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "signed_apartment_form.pdf";
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);

      setStatusMsg("PDF מאוחד הורד בהצלחה.");
    } catch (err) {
      console.error(err);
      setStatusMsg("שגיאה ביצירת PDF מאוחד – בדוק את הקונסול.");
    } finally {
      setIsBusy(false);
    }
  }

  // ====== UI ======

  if (isAdmin) {
    // מסך מנהל
    return (
      <div className="min-h-screen bg-slate-50 flex flex-col">
        <header className="w-full border-b bg-white">
          <div className="max-w-5xl mx-auto px-4 py-4 flex items-center justify-between gap-4">
            <div className="flex items-center gap-2">
              <Users className="w-6 h-6" />
              <div>
                <h1 className="text-lg font-semibold">
                  מערכת חתימות – רחבת הרב עוזיאל 4–14
                </h1>
                <p className="text-xs text-slate-500">
                  לוח בקרה למנהל – יצירת לינקים לכל דייר והפקת PDF מאוחד.
                </p>
              </div>
            </div>
            <a
              href={baseUrl}
              className="text-xs text-slate-500 underline"
            >
              {baseUrl}
            </a>
          </div>
        </header>

        <main className="flex-1 max-w-5xl mx-auto px-4 py-6 space-y-6">
          {/* קובץ PDF */}
          <section className="bg-white rounded-2xl shadow-sm p-4 space-y-3">
            <div className="flex items-center gap-2">
              <FilePenLine className="w-5 h-5" />
              <h2 className="font-semibold text-sm">
                1. טופס ה-PDF הקבוע
              </h2>
            </div>
            <p className="text-xs text-slate-500">
              העלה כאן את קובץ הטופס (אותו מסמך ששלחת לבעלי הדירות).
            </p>
            <input
              type="file"
              accept="application/pdf"
              onChange={handlePdfChange}
              className="text-xs"
            />
          </section>

          {/* טבלת דיירים + לינקים */}
          <section className="bg-white rounded-2xl shadow-sm p-4 space-y-3">
            <div className="flex items-center gap-2">
              <Users className="w-5 h-5" />
              <h2 className="font-semibold text-sm">
                2. לינק לכל דייר (32 דירות)
              </h2>
            </div>
            <p className="text-xs text-slate-500 mb-2">
              לכל דייר יש מזהה ייחודי (1–32). אפשר להעתיק את הלינק ולשלוח
              בוואטסאפ או במייל. כשייכנס – יראה רק את השורה שלו.
            </p>

            <div className="border rounded-xl overflow-hidden max-h-[420px] overflow-y-auto">
              <table className="w-full text-xs">
                <thead className="bg-slate-50 border-b">
                  <tr className="text-right">
                    <th className="p-2 w-10">#</th>
                    <th className="p-2">שם מלא</th>
                    <th className="p-2 w-20">סטטוס</th>
                    <th className="p-2 w-32">לינק</th>
                  </tr>
                </thead>
                <tbody>
                  {RESIDENTS.map((name, idx) => {
                    const index = idx + 1;
                    const hasSignature = !!allSignatures[index];
                    const link = `${baseUrl}?unitId=${index}`;
                    return (
                      <tr
                        key={index}
                        className="border-b last:border-b-0 hover:bg-slate-50"
                      >
                        <td className="p-2 text-slate-500">{index}</td>
                        <td className="p-2">{name}</td>
                        <td className="p-2">
                          {hasSignature ? (
                            <span className="inline-flex items-center gap-1 text-emerald-600">
                              <CheckCircle2 className="w-4 h-4" />
                              חתום
                            </span>
                          ) : (
                            <span className="text-slate-400">
                              ממתין
                            </span>
                          )}
                        </td>
                        <td className="p-2">
                          <button
                            onClick={() => copyLinkForUnit(index)}
                            className="inline-flex items-center gap-1 px-2 py-1 rounded-lg border text-xs hover:bg-slate-50"
                          >
                            <Copy className="w-3 h-3" />
                            העתק לינק
                          </button>
                          <div className="mt-1 text-[10px] text-slate-400 truncate">
                            {link}
                          </div>
                        </td>
                      </tr>
                    );
                  })}
                </tbody>
              </table>
            </div>
          </section>

          {/* יצוא PDF מאוחד */}
          <section className="bg-white rounded-2xl shadow-sm p-4 space-y-3">
            <div className="flex items-center gap-2">
              <FileDown className="w-5 h-5" />
              <h2 className="font-semibold text-sm">
                3. הפקת מסמך מאוחד
              </h2>
            </div>
            <p className="text-xs text-slate-500">
              לאחר שרוב/כל הדיירים חתמו, לחץ על הכפתור כדי להפיק PDF
              אחד עם כל החתימות המוטמעות על גבי הטופס המקורי.
            </p>
            <button
              onClick={exportMergedPdf}
              disabled={isBusy}
              className="inline-flex items-center gap-2 px-4 py-2 rounded-xl bg-emerald-600 text-white text-xs hover:bg-emerald-700 disabled:opacity-60"
            >
              <FileDown className="w-4 h-4" />
              {isBusy ? "מעבד..." : "הורד PDF מאוחד עם חתימות"}
            </button>
          </section>

          {statusMsg && (
            <div className="text-xs text-slate-600 bg-slate-100 border rounded-xl px-3 py-2">
              {statusMsg}
            </div>
          )}
        </main>
      </div>
    );
  }

  // ====== מסך דייר (עם unitId ב-URL) ======
  return (
    <div className="min-h-screen bg-gradient-to-b from-slate-50 to-slate-100 flex flex-col">
      <header className="w-full border-b bg-white/80 backdrop-blur">
        <div className="max-w-xl mx-auto px-4 py-4 flex items-center justify-between gap-3">
          <div className="flex items-center gap-2">
            <FilePenLine className="w-6 h-6 text-sky-600" />
            <div>
              <h1 className="text-base font-semibold">
                טופס הסכמה עקרונית ומינוי נציגות
              </h1>
              <p className="text-[11px] text-slate-500">
                רחבת הרב עוזיאל 4–14, באר שבע
              </p>
            </div>
          </div>
          <span className="text-[10px] text-slate-400">
            דירה #{unitId}
          </span>
        </div>
      </header>

      <main className="flex-1 max-w-xl mx-auto px-4 py-5 space-y-4">
        <section className="bg-white rounded-2xl shadow-sm p-4 space-y-3">
          <h2 className="text-sm font-semibold mb-1">
            פרטי הזיהוי שלך
          </h2>
          <div className="grid gap-3 text-sm">
            <div>
              <label className="block text-xs text-slate-500 mb-1">
                שם מלא (לפי רשימת בעלי הדירות)
              </label>
              <input
                type="text"
                value={residentName || ""}
                readOnly
                className="w-full rounded-xl border bg-slate-50 px-3 py-2 text-right text-sm"
              />
            </div>
            <div>
              <label className="block text-xs text-slate-500 mb-1">
                תאריך
              </label>
              <input
                type="text"
                value={todayLabel}
                readOnly
                className="w-full rounded-xl border bg-slate-50 px-3 py-2 text-right text-sm"
              />
            </div>
          </div>
          <p className="text-[11px] text-slate-500 mt-1">
            אנא ודא ששםך מופיע נכון לפני החתימה.
          </p>
        </section>

        <section className="bg-white rounded-2xl shadow-sm p-4 space-y-3">
          <h2 className="text-sm font-semibold">המסמך לחתימה</h2>
          <p className="text-[11px] text-slate-500">
            מומלץ לעיין במסמך המלא לפני החתימה. לחיצה תפתח את ה-PDF
            בלשונית חדשה.
          </p>
          <a
            href="/form.pdf"
            target="_blank"
            rel="noreferrer"
            className="inline-flex items-center justify-center w-full px-3 py-2 rounded-xl border text-xs hover:bg-slate-50"
          >
            צפייה בטופס ה-PDF
          </a>
        </section>

        <section className="bg-white rounded-2xl shadow-sm p-4 space-y-3">
          <h2 className="text-sm font-semibold mb-1">חתימה דיגיטלית</h2>
          <p className="text-[11px] text-slate-500">
            חתום/י באצבע (בטלפון) או בעזרת עכבר. אם יצא לא טוב, אפשר
            ללחוץ על "נקה" ולנסות שוב.
          </p>
          <div className="border rounded-2xl bg-slate-50 px-2 py-2">
            <SignatureCanvas
              ref={sigPadRef}
              penColor="black"
              canvasProps={{
                width: 480,
                height: 180,
                className:
                  "w-full h-[180px] bg-white rounded-xl shadow-inner",
              }}
            />
          </div>
          <div className="flex justify-between gap-2 mt-2">
            <button
              type="button"
              onClick={clearSignature}
              className="px-3 py-2 rounded-xl border text-xs hover:bg-slate-50"
            >
              נקה חתימה
            </button>
            <button
              type="button"
              onClick={saveSignatureForUnit}
              className="px-4 py-2 rounded-xl bg-sky-600 text-white text-xs hover:bg-sky-700"
            >
              שמירת חתימה
            </button>
          </div>
        </section>

        {statusMsg && (
          <div className="text-xs text-slate-600 bg-slate-100 border rounded-xl px-3 py-2">
            {statusMsg}
          </div>
        )}
      </main>

      <footer className="max-w-xl mx-auto px-4 pb-4 text-[10px] text-slate-400 text-center">
        החתימה כאן היא לצורך הסכמה עקרונית בלבד ואינה מחליפה ייעוץ משפטי
        אישי.
      </footer>
    </div>
  );
}
